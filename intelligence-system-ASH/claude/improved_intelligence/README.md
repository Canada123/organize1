# Code Intelligence Toolkit

This directory contains a **project‑level wrapper** around the unified code
intelligence system.  The tooling here allows you to explore and analyse
any repository that has been indexed into a `PROJECT_INDEX.json` file.
The scripts are designed for use within Claude Code sessions and are
integrated with subagents and slash commands.  You can also run
everything from the command line using Node.js.

## Prerequisites

* **Node.js ≥ 18** – The CLI utilities are written in ECMAScript modules
  and require a modern Node runtime.  Install Node from your package
  manager or [nodejs.org](https://nodejs.org/).
* **jq and ripgrep (optional)** – Some features delegate to external
  binaries (e.g. `rg` for content search).  The tools will gracefully
  degrade when dependencies are missing, but installing them is
  recommended for full functionality.
* **PROJECT_INDEX.json** – A repository index generated by the
  `claude-code` `/index` command or any compatible indexer.  The
  index should live in the project root next to the `.claude` folder.

## Installation

1. From the project root, install dependencies:

   ```bash
   npm install
   ```

   This will install the `intel_mjs` package along with its
   dependencies in `node_modules`.  You do not need to install
   anything inside the `.claude/improved_intelligence` directory.

2. Ensure your `PROJECT_INDEX.json` file exists.  If not, run the
   `/index` slash command in Claude Code to generate it.  The CLI
   refuses to run if the index is missing.

3. (Optional) Create a `.code-intel-config.json` in the project root to
   override default configuration.  See the **Configuration** section
   below for supported settings.

## Usage

All commands can be executed via Node.  The recommended entry point
for subagents and CLI usage is `code-intel.mjs` inside this
directory.  For example:

```bash
# Display help and basic information
node .claude/improved_intelligence/code-intel.mjs help

# Generate a compact overview of your project (statistics + hotspots)
node .claude/improved_intelligence/code-intel.mjs preset compact

# Run a standard analysis (overview + patterns + hotspots)
node .claude/improved_intelligence/code-intel.mjs preset standard

# Run the extended analysis (overview + patterns + hotspots + graph stats + cycles)
node .claude/improved_intelligence/code-intel.mjs preset extended

# Execute a custom chain of operations from a JSON file
node .claude/improved_intelligence/code-intel.mjs chain .claude/improved_intelligence/workflows/investigate.json

# Find callers of a function
node .claude/improved_intelligence/code-intel.mjs callers myFunction

# Identify dependency cycles in the call graph
node .claude/improved_intelligence/code-intel.mjs graph cycles

# Perform a bug investigation flow for the keyword "undefined"
node .claude/improved_intelligence/code-intel.mjs bug undefined

# Aggregate previously generated reports into a single document
node .claude/improved_intelligence/aggregate.mjs
```

### Commands

The CLI exposes a rich set of commands.  Key operations include:

- **overview [30|60|90]** – Produce a 30‑, 60‑ or 90‑second overview of the
  project.  Higher values include more detail such as hotspots and
  architecture stats.
- **hotspots [limit]** – List the top N dependency hotspots (files with
  high centrality).
- **patterns [type]** – Detect code patterns and smells.  Types include
  `circular`, `dead`, `god` or leave empty for all.
- **graph stats|path|cycles** – Operate on the call/dependency graph.
  `stats` returns graph statistics; `path <from> <to>` finds the shortest
  path between two functions; `cycles` lists all dependency cycles.
- **find, files, content, symbol, callers, deps** – Various search and
  discovery functions to locate files, symbols and dependencies.
- **feature <name>**, **bug <pattern>**, **refactor <file>** – High‑level
  workflows for feature development, bug investigation and refactoring.
- **preset <name>** – Run a built‑in preset (`compact`, `standard` or
  `extended`).  Presets orchestrate multiple analyses in a token‑efficient
  manner.  Presets can be customised via `.code-intel-config.json`.
- **chain <file>** – Execute a custom chain of commands defined in a JSON
  file.  See the **Workflows** section below.

Run `node .claude/improved_intelligence/code-intel.mjs help` to see the full
list of commands.

### Workflows and Chain Definitions

Complex analysis scenarios can be composed into reusable **chains**.
Chain definitions live in the `workflows` folder in this directory.
Each JSON file contains an array of steps.  Each step has a
`command` property (matching a CLI command) and an optional `args`
array.  When you run `code-intel chain <file>`, the CLI executes each
step in order.  The following chains are provided:

| Chain | Purpose | Steps |
|------|---------|-------|
| **onboarding.json** | Quickly orient new developers to the codebase.  Runs a 60‑second overview, identifies the top 15 hotspots, performs a pattern analysis and shows graph statistics. | `overview 60 → hotspots 15 → patterns → graph stats` |
| **investigate.json** | Starting point for bug or issue investigation.  Performs a bug investigation (default pattern is `UNSPECIFIED_PATTERN` – replace with your search term), runs a comprehensive pattern analysis, lists the top 10 hotspots and reports on dependency cycles. | `bug UNSPECIFIED_PATTERN → patterns → hotspots 10 → graph cycles` |
| **audit.json** | Thorough audit of code quality and architecture.  Runs a 90‑second overview, full pattern scan, lists the top 20 hotspots and outputs graph statistics and cycles. | `overview 90 → patterns → hotspots 20 → graph stats → graph cycles` |

To create your own chains, copy one of the JSON files and adjust the
`command` and `args` properties.  You can chain any commands exposed
by the CLI.  Chains are ideal for repeatable analyses, CI workflows
and subagent sequences.

### Configuration

Create a `.code-intel-config.json` in your project root to customise
domain keywords, test patterns and presets.  Example:

```json
{
  "domainKeywords": ["auth", "billing"],
  "testPatterns": ["**/*.spec.ts", "**/*.test.tsx"],
  "presets": {
    "compact": ["overview", "hotspots"],
    "standard": ["overview 60", "patterns", "hotspots 10"],
    "extended": ["overview 90", "patterns", "hotspots 20", "graph stats", "graph cycles"]
  }
}
```

The configuration loader looks for `.code-intel-config.json` or
respects the `CODE_INTEL_CONFIG` environment variable.

## Report Aggregation

When running analyses that output multiple reports (e.g. using
`--output` or the `specific` command in other versions), reports are
stored in `.index-analysis/temp/<timestamp>`.  Run the aggregator
script to collate them:

```bash
node .claude/improved_intelligence/aggregate.mjs
```

This script scans the `.index-analysis/temp` directory, reads all
Markdown, JSON and text files from each run and concatenates them
into `.index-analysis/aggregated-report.md`.  It does not perform
semantic summarisation—that responsibility lies with the aggregator
subagent.  After running, open the aggregated report for a
comprehensive view of your analyses.

## Integration with Subagents

This toolkit is designed to work seamlessly with Claude Code subagents.
In the `.claude/agents` directory you will find definitions for
several specialized subagents:

* **index‑analyzer** – Provides deep code intelligence from the
  JQ‑based tool.  This agent is retained for backward compatibility.
* **index‑analyzer‑parallel** – Coordinates parallel analysis flows
  using the Node‑based CLI.  It executes presets and chains in
  separate sessions and writes results into `.index-analysis/temp`.
* **index‑analysis‑aggregator** – Merges intermediate reports and
  synthesises a high‑level summary.  It invokes `aggregate.mjs` and
  produces human‑readable reports for the main agent.

Each subagent references this README via the `@.claude/improved_intelligence/README.md`
annotation in its prompt.  That annotation causes the file to be
loaded into the subagent’s context, giving it access to these
instructions.  Similarly, they reference the CLI using
`@.claude/improved_intelligence/code-intel.mjs` so they can execute commands.

For details on creating and managing subagents, see
`claude-docs/claude-code_subagents.md` in the documentation bundle.

## Contributing

Feel free to extend the CLI with additional commands or workflows.
Always write comprehensive documentation and keep token budgets in
mind.  When adding new presets or chains, remember to update this
README and the associated subagent prompts to reflect the changes.
