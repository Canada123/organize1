name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check code formatting
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"
      
      - name: Run all checks
        run: npm run check
      
      - name: Check bundle size
        run: |
          npm run build
          npx size-limit --json > size-report.json || true
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            let comment = '## üìä PR Quality Report\n\n';
            
            // Add check results
            comment += '### ‚úÖ Quality Checks\n';
            comment += '- ‚úì Linting passed\n';
            comment += '- ‚úì Type checking passed\n';
            comment += '- ‚úì Tests passed\n\n';
            
            // Add bundle size if available
            try {
              const sizeReport = JSON.parse(fs.readFileSync('size-report.json', 'utf8'));
              comment += '### üì¶ Bundle Size\n';
              comment += '```\n' + JSON.stringify(sizeReport, null, 2) + '\n```\n';
            } catch (e) {
              // Size report not available
            }
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('PR Quality Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  medical-compliance:
    name: Medical Compliance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for protected component modifications
        run: |
          # Check if TabNavigation component was modified
          if git diff origin/${{ github.base_ref }}..HEAD --name-only | grep -E "TabNavigation|TodayTab|HeartBalanceRing|ContributingFactorCards"; then
            echo "‚ùå Protected medical components were modified!"
            echo "These components are clinically validated and require CEO approval."
            exit 1
          fi
      
      - name: Check for medical claim modifications
        run: |
          # Check for changes in medical-related content
          git diff origin/${{ github.base_ref }}..HEAD -- '*.tsx' '*.ts' '*.md' | grep -E "(FDA|CE mark|medical device|clinical|diagnosis|treatment)" || true